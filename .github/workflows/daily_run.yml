name: Daily Background Update

on:
  schedule:
    - cron: "0 0 * * *" # Runs daily at 00:00 UTC
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install OS dependencies (ffmpeg)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run TMDB Color Script
        env:
          # API Configuration
          TMDB_BEARER_TOKEN: ${{ secrets.TMDB_BEARER_TOKEN }}
          TMDB_BASE_URL: ${{ vars.TMDB_BASE_URL }}
          TMDB_IMG_BASE: ${{ vars.TMDB_IMG_BASE }}
          TMDB_LANGUAGE: ${{ vars.TMDB_LANGUAGE }}

          # Content Settings
          TMDB_NUMBER_OF_MOVIES: ${{ vars.TMDB_NUMBER_OF_MOVIES }}
          TMDB_NUMBER_OF_TVSHOWS: ${{ vars.TMDB_NUMBER_OF_TVSHOWS }}
          MAX_CONTENT_AGE_DAYS: ${{ vars.MAX_CONTENT_AGE_DAYS }}
          TMDB_CUSTOM_TEXT: ${{ vars.TMDB_CUSTOM_TEXT }}

          # Output Settings
          OUTPUT_DIR: ${{ vars.OUTPUT_DIR }}
          CLEAN_OUTPUT_DIR: ${{ vars.CLEAN_OUTPUT_DIR }}
          PAGES_GITHUB_URL: ${{ vars.PAGES_GITHUB_URL }}

          # Video Quality
          TARGET_WIDTH: ${{ vars.TARGET_WIDTH }}
          TARGET_HEIGHT: ${{ vars.TARGET_HEIGHT }}
          VIDEO_FPS: ${{ vars.VIDEO_FPS }}
          VIDEO_DURATION: ${{ vars.VIDEO_DURATION }}
          VIDEO_CRF: ${{ vars.VIDEO_CRF }}
          VIDEO_PRESET: ${{ vars.VIDEO_PRESET }}
          VIDEO_ZOOM: ${{ vars.VIDEO_ZOOM }}
          VIDEO_PAN_START_MARGIN: ${{ vars.VIDEO_PAN_START_MARGIN }}
          VIDEO_PAN_END_MARGIN: ${{ vars.VIDEO_PAN_END_MARGIN }}

          # Image Quality
          IMAGE_QUALITY: ${{ vars.IMAGE_QUALITY }}
          BLUR_RADIUS: ${{ vars.BLUR_RADIUS }}
          VIGNETTE_STRENGTH: ${{ vars.VIGNETTE_STRENGTH }}

          # Performance Tuning
          MAX_WORKERS_DOWNLOAD: ${{ vars.MAX_WORKERS_DOWNLOAD }}
          MAX_WORKERS_PROCESS: ${{ vars.MAX_WORKERS_PROCESS }}
          FONT_PATH: ${{ vars.FONT_PATH }}

          # Content Filtering
          EXCLUDED_COUNTRIES: ${{ vars.EXCLUDED_COUNTRIES }}
          EXCLUDED_KEYWORDS: ${{ vars.EXCLUDED_KEYWORDS }}
        run: python TMDB_color.py

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./tmdb_backgrounds
          publish_branch: gh-pages # The branch where the static files will be pushed
